<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Home Admin</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js" integrity="sha512-aUhL2xOCrpLEuGD5f6tgHbLYEXRpYZ8G5yD+WlFrXrPy2IrWBlu6bih5C9H6qGsgqnU6mgx6KtU8TreHpASprw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script>
        $(document).ready( function() {
            if ($.cookie("access_token")) {
                $("#logout-div").show();
            } else {
                $("#logout-div").hide();
            }
            $.ajax({
                url: "/api/v1/users",
                // url: "/api/v1/devices",
                contentType: "application/json; charset=utf-8",
                method: "GET",
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + $.cookie("access_token"));
                }
            }).done(function(res) {
                $("#content").text(res);
            }).fail(function(res) {
                window.location = "/login";
            });
        });
        function logout() {
            $.removeCookie("access_token", { path: '/' });
            window.location = "/login";
        }
        function card_delete(card_id) {
            if (confirm("Are you sure you want to delete this card?")) {
                $.ajax({
                    url: `/api/v1/cards/${card_id}`,
                    type: 'DELETE',
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("Authorization", "Bearer " + $.cookie("access_token"));
                    },
                    success: function(result) {
                        alert("Card deleted successfully.");
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        alert("Failed to delete card: " + error);
                    }
                });
            }
        }
        function device_delete(device_id) {
            if (confirm("Are you sure you want to delete this device?")) {
                $.ajax({
                    url: `/api/v1/devices/${device_id}`,
                    type: 'DELETE',
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("Authorization", "Bearer " + $.cookie("access_token"));
                    },
                    success: function(result) {
                        alert("Device deleted successfully.");
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        alert("Failed to delete device: " + error);
                    }
                });
            }
        }
        function schedule_enable() {
            $.ajax({
                url: `/api/v1/devices/1`,
                type: 'PUT',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + $.cookie("access_token"));
                },
                success: function(result) {
                    alert("Device toggled successfully.");
                    location.reload();
                },
                error: function(xhr, status, error) {
                    alert("Failed to toggle the device: " + error);
                }
            });
        }
        function schedule_delete(schedule_id) {
            if (confirm("Are you sure you want to delete this charging schedule?")) {
                $.ajax({
                    url: `/api/v1/scheduled/${schedule_id}`,
                    type: 'DELETE',
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("Authorization", "Bearer " + $.cookie("access_token"));
                    },
                    success: function(result) {
                        alert("Device deleted successfully.");
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        alert("Failed to delete device: " + error);
                    }
                });
            }
        }
    </script>
    <script>
        fetch('/api/v1/cards')
            .then(response => response.json())
            .then(cards => {
            const content = document.getElementById('card-content');
            content.innerHTML = '';

            
            cards.forEach((card, index) => {
                const row = document.createElement('tr');

                row.innerHTML = `
                <td scope="row">${card.id}</td>
                <td>${card.cardname}</td>
                <td>${card.cardnumber}</td>
                <td>
                    <a class="btn btn-danger btn-sm" onclick="card_delete(${card.id})">Delete</a>
                </td>
                `;

                content.appendChild(row);
            });
            })
            .catch(error => {
                console.error('Failed to get Card list:', error);
            });
    </script>
    <script>
        fetch('/api/v1/devices')
            .then(response => response.json())
            .then(devices => {
            const content = document.getElementById('device-content');
            content.innerHTML = '';

            
            devices.forEach((device, index) => {
                const row = document.createElement('tr');

                row.innerHTML = `
                <td scope="row">${device.id}</td>
                <td>${device.serialnumber}</td>
                <td>${device.maxcurrent}</td>
                <td>${device.schedule_enabled}</td>
                <td>
                    <a class="btn btn-danger btn-sm" onclick="device_delete(${device.id})">Delete</a>
                </td>
                `;

                content.appendChild(row);
            });
            const scheduleStatus = document.getElementById('schedule-status');
            scheduleStatus.innerHTML = `
                <h5>Scheduled Charging: ${devices.some(device => device.schedule_enabled) ? 'Enabled' : 'Disabled'}</h5>
            `;
            })
            .catch(error => {
                console.error('Failed to get Device list:', error);
            });
    </script>
    <script>
        fetch('/api/v1/scheduled')
            .then(response => response.json())
            .then(schedules => {
            const content = document.getElementById('schedule');
            content.innerHTML = '';

            
            schedules.forEach((schedule, index) => {
                const row = document.createElement('tr');

                row.innerHTML = `
                <td scope="row">${schedule.id}</td>
                <td>${schedule.timezone}</td>
                <td>${schedule.starttime}</td>
                <td>${schedule.endtime}</td>
                <td>
                    <a class="btn btn-danger btn-sm" onclick="schedule_delete(${schedule.id})">Delete</a>
                </td>
                `;

                content.appendChild(row);
            });
            })
            .catch(error => {
                console.error('Failed to get Schedule list:', error);
            });
    </script>
</head>
<body>
    <div class="container">
        <div class="row mt-5">
            <h1>CP700P Settings</h1>
        </div>
        <div class="text-end" id="logout-div">
            <button class="btn btn-primary" onclick="location.href='/chpasswd'">Change Password</button>
            <button class="btn btn-primary" onclick="logout();">Logout</button>
        </div>
        <div class="row mt-5 col-12">
            <div class="col-6"> 
                <h4>Wifi Device settings</h4>
                <table class="table table-light">
                    <thead class="thead-light">
                        <tr>
                        <th scope="col">#</th>
                        <th scope="col">Serial Number</th>
                        <th scope="col">Max. Current[A]</th>
                        <th scope="col">Schedule_enabled</th>
                        <th scope="col">Delete</th>
                        </tr>
                    </thead>
                    <tbody class="text-dark" id="device-content">
                    </tbody>
                </table>
                <button class="btn btn-primary btn-sm" onclick="location.href='/devregister'">Add Device</button>
            </div>
            <div class="col-6">
                <h4>Charging Cards Registration</h4>
                <table class="table table-light">
                    <thead class="thead-light">
                        <tr>
                        <th scope="col">#</th>
                        <th scope="col">Card Name</th>
                        <th scope="col">Card Number</th>
                        <th scope="col">Delete</th>
                        </tr>
                    </thead>
                    <tbody class="text-dark" id="card-content">
                    </tbody>
                </table>
                <button class="btn btn-primary btn-sm" onclick="location.href='/cardregister'">Add Card</button>
                <button class="btn btn-primary btn-sm" onclick="location.href='/cardregisteronline'">Online Registration</button>
            </div>
        </div>
        <div class="row mt-5">
            <h4>Scheduled Charging Settings</h4>
            <h5>1. Click the ENABLE button to enable scheduled charging.</h5>
            <h5>2. While charging, if you tag a charging card or disconnect the cable, the charging will be stopped.</h5>
            <h5>3. Even if scheduled charging is enabled, it will be bypassed if a card authenticates and connects the cable to begin charging immediately.</h5>
        </div>
        <div class="row mt-3 col-12">
            <div class="col-4">
                <div id="schedule-status"></div>
                <button class="btn btn-primary btn-sm" onclick="schedule_enable()">Toggle Enable / Disable Schedule</button>
            </div>
            <div class="col-8">
                <table class="table table-light">
                    <thead class="thead-light">
                        <tr>
                        <th scope="col">#</th>
                        <th scope="col">Time Zone</th>
                        <th scope="col">Start Time</th>
                        <th scope="col">End Time</th>
                        <th scope="col">Delete</th>
                        </tr>
                    </thead>
                    <tbody class="text-dark" id="schedule">
                    </tbody>
                </table>
                <button class="btn btn-primary btn-sm" onclick="location.href='/setschedule'">Set Schedule</button>
            </div>
        </div>
    </div>
</body>
</html>