{% extends "base.html" %}
{% block head %}
<script>
    $(document).ready( function() {
        if ($.cookie("access_token")) {
            $("#logout-div").show();
        } else {
            $("#logout-div").hide();
        }
        $.ajax({
            url: "/api/v1/users",
            // url: "/api/v1/devices",
            contentType: "application/json; charset=utf-8",
            method: "GET",
            beforeSend: function(xhr) {
                xhr.setRequestHeader("Authorization", "Bearer " + $.cookie("access_token"));
            }
        }).done(function(res) {
            $("#content").text(res);
        }).fail(function(res) {
            window.location = "/login";
        });
    });
    function logout() {
        $.removeCookie("access_token", { path: '/' });
        window.location = "/login";
    }
    function card_delete(card_id) {
        if (confirm("Are you sure you want to delete this card?")) {
            $.ajax({
                url: `/api/v1/cards/${card_id}`,
                type: 'DELETE',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + $.cookie("access_token"));
                },
                success: function(result) {
                    alert("Card deleted successfully.");
                    location.reload();
                },
                error: function(xhr, status, error) {
                    alert("Failed to delete card: " + error);
                }
            });
        }
    }
    function device_delete(device_id) {
        if (confirm("Are you sure you want to delete this device?")) {
            $.ajax({
                url: `/api/v1/devices/${device_id}`,
                type: 'DELETE',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + $.cookie("access_token"));
                },
                success: function(result) {
                    alert("Device deleted successfully.");
                    location.reload();
                },
                error: function(xhr, status, error) {
                    alert("Failed to delete device: " + error);
                }
            });
        }
    }
    function schedule_enable() {
        $.ajax({
            url: `/api/v1/scheduled/1`,
            type: 'PUT',
            beforeSend: function(xhr) {
                xhr.setRequestHeader("Authorization", "Bearer " + $.cookie("access_token"));
            },
            success: function(result) {
                alert("Device toggled successfully.");
                location.reload();
            },
            error: function(xhr, status, error) {
                alert("Failed to toggle the device: " + error);
            }
        });
    }
    function schedule_delete(schedule_id) {
        if (confirm("Are you sure you want to delete this charging schedule?")) {
            $.ajax({
                url: `/api/v1/scheduled/${schedule_id}`,
                type: 'DELETE',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + $.cookie("access_token"));
                },
                success: function(result) {
                    alert("Device deleted successfully.");
                    location.reload();
                },
                error: function(xhr, status, error) {
                    alert("Failed to delete device: " + error);
                }
            });
        }
    }
</script>
<script>
    fetch('/api/v1/cards')
        .then(response => response.json())
        .then(cards => {
        const content = document.getElementById('card-content');
        content.innerHTML = '';

        
        cards.forEach((card, index) => {
            const row = document.createElement('tr');

            row.innerHTML = `
            <td scope="row">${card.id}</td>
            <td>${card.cardname}</td>
            <td>${card.cardnumber}</td>
            <td>${card.status}</td>
            <td>${card.expirydate}</td>
            <td>
                <a class="btn btn-danger btn-sm" onclick="card_delete(${card.id})">Delete</a>
            </td>
            `;

            content.appendChild(row);
        });
        })
        .catch(error => {
            console.error('Failed to get Card list:', error);
        });
</script>
<script>
    fetch('/api/v1/devices')
        .then(response => response.json())
        .then(devices => {
        const content = document.getElementById('device-content');
        content.innerHTML = '';

        
        devices.forEach((device, index) => {
            const row = document.createElement('tr');

            row.innerHTML = `
            <td scope="row">${device.id}</td>
            <td>${device.serialnumber}</td>
            <td>${device.maxcurrent}</td>
            <td>
                <a class="btn btn-danger btn-sm" onclick="device_delete(${device.id})">Delete</a>
            </td>
            `;

            content.appendChild(row);
        });
        })
        .catch(error => {
            console.error('Failed to get Device list:', error);
        });
</script>
<script>
    fetch('/api/v1/scheduled')
        .then(response => response.json())
        .then(schedules => {
        const content = document.getElementById('schedule');
        content.innerHTML = '';

        
        schedules.forEach((schedule, index) => {
            const row = document.createElement('tr');

            row.innerHTML = `
            <td scope="row">${schedule.id}</td>
            <td>${schedule.priority}</td>
            <td>${schedule.timezone}</td>
            <td>${schedule.starttime}</td>
            <td>${schedule.endtime}</td>
            <td>
                <a class="btn btn-danger btn-sm" onclick="schedule_delete(${schedule.id})">Delete</a>
            </td>
            `;

            content.appendChild(row);
        });
        const scheduleStatus = document.getElementById('schedule-status');
        const enabled = schedules.some(schedule => schedule.schedule_enabled);
        scheduleStatus.innerHTML = `
            <h5>Scheduled Charging: <span class="${enabled ? 'text-success' : 'text-danger'}">
                ${enabled ? 'Enabled' : 'Disabled'}
            </span></h5>
        `;
        })
        .catch(error => {
            console.error('Failed to get Schedule list:', error);
        });
</script>
<script>
    const source = new EventSource('/stream'); 

    source.onopen = function() {
        document.getElementById('energy-status').innerHTML = "서버 연결 성공. 데이터를 기다리는 중...";
        console.log("SSE 연결이 성공적으로 수립되었습니다.");
    };

    source.onmessage = function(event) {
        const receivedData = event.data; 
        
        const container = document.getElementById('energy-status');
        
        container.innerHTML = `<p>Time: ${new Date().toLocaleTimeString()} - Current: <strong>${receivedData}</strong></p>`;
        
        container.scrollTop = container.scrollHeight;
        
        console.log("새로운 데이터 수신:", receivedData);
    };
    
    // 4. 특정 이벤트 이름을 지정하여 처리 (옵션)
    // 만약 서버가 event: 'temperature' 형태로 데이터를 보낸다면 이 핸들러가 작동합니다.
    source.addEventListener('temperature', function(event) {
            const temp = JSON.parse(event.data);
            console.log("온도 데이터 수신:", temp.value);
            // 해당 온도 데이터를 처리하는 로직 추가
    });

    // 5. 연결 오류 핸들러
    source.onerror = function(error) {
        console.error("SSE 연결 오류 발생:", error);
        document.getElementById('energy-status').innerHTML = "SSE 연결 오류 발생. 재연결 시도 중...";
        // EventSource는 기본적으로 연결이 끊어지면 자동으로 재연결을 시도합니다.
    };
</script>
{% endblock %}
{% block contents %}
<div class="container">
    <div class="row mt-5">
        <h1>CP700P Settings</h1>
    </div>
    <div class="text-end" id="logout-div">
        <button class="btn btn-primary" onclick="location.href='/chpasswd'">Change Password</button>
        <button class="btn btn-primary" onclick="logout();">Logout</button>
    </div>
    <div class="row mt-5">
        <div class="col-12 col-md-6"> 
            <h4>Power Monitor settings</h4>
            <div id="energy-status"></div>
            <div class="table-responsive">
                <table class="table table-light">
                    <thead class="thead-light">
                        <tr>
                        <th scope="col">#</th>
                        <th scope="col">Serial Number</th>
                        <th scope="col">Max. Current[A]</th>
                        <th scope="col">Delete</th>
                        </tr>
                    </thead>
                    <tbody class="text-dark" id="device-content">
                    </tbody>
                </table>
            </div>
            <button class="btn btn-primary btn-sm" onclick="location.href='/devregister'">Add Device</button>
        </div>
        <div class="col-12 col-md-6">
            <h4>Charging Cards Registration</h4>
            <div class="table-responsive">
                <table class="table table-light">
                    <thead class="thead-light">
                        <tr>
                        <th scope="col">#</th>
                        <th scope="col">Card Name</th>
                        <th scope="col">Card Number</th>
                        <th scope="col">Card Status</th>
                        <th scope="col">Expiry Date</th>
                        <th scope="col">Delete</th>
                        </tr>
                    </thead>
                    <tbody class="text-dark" id="card-content">
                    </tbody>
                </table>
            </div>
            <button class="btn btn-primary btn-sm" onclick="location.href='/cardregister'">Add Card</button>
            <button class="btn btn-primary btn-sm" onclick="location.href='/cardregisteronline'">Online Registration</button>
        </div>
    </div>
    <div class="row mt-5">
        <h4>Scheduled Charging Settings</h4>
        <h5>1. Click the ENABLE button to enable scheduled charging.</h5>
        <h5>2. While charging, if you tag a charging card or disconnect the cable, the charging will be stopped.</h5>
        <h5>3. Even if scheduled charging is enabled, it will be bypassed if a card authenticates and connects the cable to begin charging immediately.</h5>
    </div>
    <div class="row mt-3 col-12">
        <div class="col-4">
            <div id="schedule-status"></div>
            <button class="btn btn-primary btn-sm" onclick="schedule_enable()">Toggle to Enable / Disable Schedule</button>
        </div>
        <div class="col-8">
            <table class="table table-light">
                <thead class="thead-light">
                    <tr>
                    <th scope="col">#</th>
                    <th scope="col">Priority</th>
                    <th scope="col">Time Zone</th>
                    <th scope="col">Start Time</th>
                    <th scope="col">End Time</th>
                    <th scope="col">Delete</th>
                    </tr>
                </thead>
                <tbody class="text-dark" id="schedule">
                </tbody>
            </table>
            <button class="btn btn-primary btn-sm" onclick="location.href='/setschedule'">Set Schedule</button>
        </div>
    </div>
</div>
{% endblock %}